# Student Registrar

A comprehensive homeschool management system built with .NET Aspire, Keycloak, PostgreSQL, and Next.js.

## Features

- **Student Management**: Register and manage student information
- **Course Management**: Create and organize courses
- **Enrollment Tracking**: Track student enrollments in courses
- **Grade Recording**: Record and manage student grades
- **Authentication**: Secure authentication via Keycloak
- **Modern UI**: Beautiful, responsive frontend built with Next.js and Tailwind CSS
- **Containerized**: Easy deployment with Docker

## Architecture

- **Backend**: .NET 9 Web API with Entity Framework Core
- **Frontend**: Next.js 15 with TypeScript and Tailwind CSS
- **Database**: PostgreSQL 15
- **Authentication**: Keycloak
- **Orchestration**: .NET Aspire for local development
- **Containerization**: Docker and Docker Compose

## Prerequisites

- [.NET 9 SDK](https://dotnet.microsoft.com/download/dotnet/9.0)
- [Node.js 18+](https://nodejs.org/)
- [Docker](https://www.docker.com/get-started)
- [Docker Compose](https://docs.docker.com/compose/install/)

## Security and Password Management

This application implements secure password management with the following features:

### Auto-Generated Passwords
- **PostgreSQL**: Password is auto-generated by .NET Aspire on each run
- **Keycloak**: Admin password is auto-generated by .NET Aspire on each run
- **Password Rotation**: All service passwords rotate automatically when the application restarts

### No Hardcoded Secrets
- All sensitive configuration is managed through .NET Aspire's parameter system
- No passwords are stored in source code or configuration files
- Development secrets are stored in user secrets when needed

### Accessing Service Credentials
- All auto-generated passwords are displayed in the Aspire Dashboard
- Navigate to http://localhost:15888 after starting the application
- View the Resources tab to see connection strings and credentials for each service

### Production Deployment
- Use environment variables or secure secret management solutions
- Configure proper authentication and authorization
- Enable HTTPS/TLS for all services

## Quick Start with Docker

The easiest way to get started is using Docker Compose:

```bash
# Clone the repository
git clone <repository-url>
cd student-registrar

# Start all services
docker-compose up -d

# Wait for services to be ready, then open:
# - Frontend: http://localhost:3000
# - API: http://localhost:5000/swagger
# - Keycloak Admin: http://localhost:8080 (admin/admin)
```

## Development Setup

### Automated Setup (Recommended)

Use the provided setup script for automatic configuration:

```bash
# Clone the repository
git clone <repository-url>
cd student-registrar

# Run the automated setup script
./dev-setup.sh

# Start the application
dotnet run --project src/StudentRegistrar.AppHost

# Or, to use hot reload:
dotnet watch run --project src/StudentRegistrar.AppHost/StudentRegistrar.AppHost.csproj
```

The setup script will:
- Install .NET Aspire workload
- Install frontend dependencies
- Configure user secrets for development
- Create Entity Framework migrations
- Set up secure auto-generated passwords for all services

### Manual Setup

If you prefer to set up manually:

### 1. Clone the Repository

```bash
git clone <repository-url>
cd student-registrar
```

### 2. Set up the Backend

```bash
# Restore NuGet packages
dotnet restore

# Initialize user secrets for development
dotnet user-secrets init --project src/StudentRegistrar.AppHost

# Run database migrations (after starting the application)
dotnet ef database update --project src/StudentRegistrar.Data --startup-project src/StudentRegistrar.Api
```

### 3. Set up the Frontend

```bash
cd frontend
npm install
```

### 4. Start Infrastructure Services

```bash
# Start PostgreSQL and Keycloak
docker-compose up postgres keycloak -d
```

### 5. Configure Keycloak

1. Start the application first:
   ```bash
   dotnet run --project src/StudentRegistrar.AppHost

   # Or, to use hot reload:
   dotnet watch run --project src/StudentRegistrar.AppHost/StudentRegistrar.AppHost.csproj
   ```

2. Run the automated Keycloak setup script:
   ```bash
   ./setup-keycloak.sh
   ```

   The script will:
   - Create the `student-registrar` realm
   - Create user roles (Administrator, Educator, Member)
   - Create the `student-registrar` client with service account enabled
   - **Configure service account permissions** for user management (manage-users role)
   - Generate and display the client secret
   - Create test users (scoopadmin, scoopmember, scoopinstructor)
   - Provide configuration commands

   **Important**: The setup script now automatically configures all necessary Keycloak permissions for admin member creation functionality. No additional permission configuration is needed.

3. **Alternative Manual Setup:**
   - Open Keycloak Admin Console: http://localhost:8080
   - Login with auto-generated admin credentials (check Aspire dashboard for credentials)
   - Create a new realm called `student-registrar`
   - Create roles: Administrator, Educator, Parent, Student
   - Create a new client:
     - Client ID: `student-registrar`
     - Client Protocol: `openid-connect`
     - Access Type: `confidential`
     - Valid Redirect URIs: `http://localhost:3000/*`, `http://localhost:3001/*`
     - Web Origins: `http://localhost:3000`, `http://localhost:3001`
     - Service Accounts Enabled: `On`

**Note:** Keycloak configuration persists across restarts thanks to persistent data volumes.

### 6. Configure AppHost Settings

The AppHost requires Keycloak client configuration. Create the configuration file:

1. **Copy the example configuration:**
   ```bash
   cp src/StudentRegistrar.AppHost/appsettings.example.json src/StudentRegistrar.AppHost/appsettings.json
   ```

2. **Update the configuration:**
   Edit `src/StudentRegistrar.AppHost/appsettings.json` with your Keycloak client secret:
   ```json
   {
     "Keycloak": {
       "Realm": "student-registrar",
       "ClientId": "student-registrar",
       "ClientSecret": "YOUR_ACTUAL_CLIENT_SECRET_HERE"
     }
   }
   ```

3. **Get the client secret:**
   - Run the setup script: `./setup-keycloak.sh` (it will display the secret)
   - Or manually from Keycloak Admin Console → student-registrar realm → Clients → student-registrar → Credentials tab

**Note:** The `appsettings.json` file is gitignored to prevent accidental secret exposure.

### 7. Run the Application

#### Using .NET Aspire (Recommended for Development)

```bash
# Run the Aspire AppHost
dotnet run --project src/StudentRegistrar.AppHost
```

This will start all services and open the Aspire dashboard.

#### Manual Start

```bash
# Terminal 1: Start the API
cd src/StudentRegistrar.Api
dotnet run

# Terminal 2: Start the frontend
cd frontend
npm run dev
```

## Project Structure

```
student-registrar/
├── src/
│   ├── StudentRegistrar.AppHost/          # .NET Aspire orchestration
│   ├── StudentRegistrar.ServiceDefaults/  # Shared service configuration
│   ├── StudentRegistrar.Api/              # Web API project
│   ├── StudentRegistrar.Data/             # Entity Framework DbContext
│   └── StudentRegistrar.Models/           # Data models
├── frontend/                              # Next.js frontend
├── docker-compose.yml                     # Docker Compose configuration
└── StudentRegistrar.sln                   # Solution file
```

## API Endpoints

### Students
- `GET /api/students` - Get all students
- `GET /api/students/{id}` - Get student by ID
- `POST /api/students` - Create new student
- `PUT /api/students/{id}` - Update student
- `DELETE /api/students/{id}` - Delete student

### Courses
- `GET /api/courses` - Get all courses
- `GET /api/courses/{id}` - Get course by ID
- `POST /api/courses` - Create new course
- `PUT /api/courses/{id}` - Update course
- `DELETE /api/courses/{id}` - Delete course

### Enrollments
- `GET /api/enrollments` - Get all enrollments
- `GET /api/enrollments/{id}` - Get enrollment by ID
- `POST /api/enrollments` - Create new enrollment
- `PUT /api/enrollments/{id}/status` - Update enrollment status
- `DELETE /api/enrollments/{id}` - Delete enrollment

### Grades
- `GET /api/grades` - Get all grades
- `GET /api/grades/{id}` - Get grade by ID
- `POST /api/grades` - Create new grade
- `PUT /api/grades/{id}` - Update grade
- `DELETE /api/grades/{id}` - Delete grade

## Database Migrations

### Create a new migration

```bash
dotnet ef migrations add <MigrationName> --project src/StudentRegistrar.Data --startup-project src/StudentRegistrar.Api
```

### Apply migrations

```bash
dotnet ef database update --project src/StudentRegistrar.Data --startup-project src/StudentRegistrar.Api
```

## Configuration

### Environment Variables

#### API Configuration
- `ConnectionStrings__DefaultConnection`: PostgreSQL connection string
- `Keycloak__Authority`: Keycloak authority URL
- `Keycloak__Realm`: Keycloak realm name

#### Frontend Configuration
- `NEXT_PUBLIC_API_URL`: API base URL
- `NEXT_PUBLIC_KEYCLOAK_URL`: Keycloak URL
- `NEXT_PUBLIC_KEYCLOAK_REALM`: Keycloak realm
- `NEXT_PUBLIC_KEYCLOAK_CLIENT_ID`: Keycloak client ID

## Security Configuration

### Development Environment

The application uses secure configuration management:

1. **User Secrets**: Sensitive data is stored in .NET user secrets (not committed to git)
2. **Environment Variables**: Alternative configuration via environment variables
3. **Secure Defaults**: No hardcoded passwords or secrets in source code

### Setting Up Secrets

**Note:** When using .NET Aspire (recommended), passwords are auto-generated and managed securely. These manual configuration options are only needed for Docker Compose deployments or custom setups.

#### Option 1: Environment Variables (For Docker Compose)
```bash
# Copy the template and edit with secure passwords
cp .env.template .env
# Edit .env file with strong, unique passwords
```

#### Option 2: User Secrets (For custom development setups)
```bash
# Initialize user secrets
dotnet user-secrets init --project src/StudentRegistrar.AppHost

# Set custom parameters if needed (not required for default Aspire setup)
dotnet user-secrets set "Parameters:postgres-password" "your-secure-password" --project src/StudentRegistrar.AppHost

# View configured secrets
dotnet user-secrets list --project src/StudentRegistrar.AppHost
```

### Production Configuration

For production deployment:
- Use Azure Key Vault or equivalent secret management service
- Configure environment-specific settings
- Follow security best practices for container orchestration

### Important Security Notes

- Never commit passwords or API keys to version control
- Use strong, unique passwords for each service
- Regularly rotate secrets in production
- Enable HTTPS in production environments
- Configure proper authentication and authorization
- Review and update dependencies regularly for security patches
- Use environment variables or secure secret management in production
- Implement proper logging and monitoring for security events

### Security Checklist for Production

Before deploying to production, ensure:

- [ ] All default passwords have been changed
- [ ] HTTPS is enabled and properly configured
- [ ] Database connections use encrypted connections
- [ ] Keycloak is properly configured with production settings
- [ ] CORS is configured for specific origins, not wildcards
- [ ] Error messages don't expose sensitive information
- [ ] Security headers are properly configured
- [ ] Regular security updates are applied
- [ ] Backup and recovery procedures are in place
- [ ] Monitoring and alerting are configured

## Production Deployment

### Using Docker Compose

```bash
# Build and start all services
docker-compose up --build -d

# View logs
docker-compose logs -f

# Stop services
docker-compose down
```

### Using Docker Images
## Keycloak Bootstrap & Test Seeding

This application ships with scripts to initialize a new Keycloak realm in a secure, repeatable way.

Location: `scripts/keycloak/`

Scripts:
- `bootstrap-keycloak.sh` – One-time realm + first application Administrator creation. Fails fast if realm already exists.
- `seed-test-users.sh` – Adds deterministic test users for development / CI (NOT for production).
- `realm-student-registrar.template.json` – Sanitized baseline realm definition (no users / secrets).

### First-Time (Interactive) Bootstrap
```
./scripts/keycloak/bootstrap-keycloak.sh --keycloak-url http://localhost:8080 \
   --admin-username admin --realm student-registrar
```
You will be prompted for:
1. Keycloak master admin password (from Aspire dashboard or secret store)
2. First application admin username
3. First application admin email
4. Temporary password (user must change on first login)

If the realm exists, the script exits with code 10 (no changes). Treat that as success in idempotent automation.

### Non-Interactive (CI / Automated Install)
```
export KEYCLOAK_ADMIN_PASSWORD="$(cat /run/secrets/kc_admin_password)"
export INITIAL_ADMIN_TEMP_PASS="TempAdmin!12345"
./scripts/keycloak/bootstrap-keycloak.sh \
   --keycloak-url http://localhost:8080 \
   --admin-username admin \
   --initial-admin-username registrar-admin \
   --initial-admin-email registrar-admin@example.org
```
Or use a password file:
```
./scripts/keycloak/bootstrap-keycloak.sh \
   --admin-password-file /run/secrets/kc_admin_password \
   --initial-admin-username registrar-admin \
   --initial-admin-email registrar-admin@example.org \
   --initial-admin-temp-pass TempAdmin!12345
```

### Seeding Test Users (Dev / CI Only)
```
./scripts/keycloak/seed-test-users.sh --keycloak-url http://localhost:8080 --realm student-registrar
```
Creates:
- scoopadmin (Administrator)
- scoopmember (Member)
- scoopeducator (Educator)

Do NOT run the seeding script in production.

### Updating Realm Template
1. Make changes in a disposable Keycloak instance.
2. Export (without users):
```
docker exec -it <kc-container> /opt/keycloak/bin/kc.sh export --realm student-registrar --dir /tmp/export --users skip
```
3. Copy JSON out, sanitize, replace `realm-student-registrar.template.json`.
4. Commit changes.

### Future Enhancements (Planned)
- Automated smoke test: client credentials token retrieval
- Optional password policy enforcement script
- Redirect URI dynamic injection for production hostnames


Build individual images:

```bash
# Build API image
docker build -t student-registrar-api -f src/StudentRegistrar.Api/Dockerfile .

# Build frontend image
docker build -t student-registrar-frontend -f frontend/Dockerfile ./frontend
```

## Testing

### End-to-End (E2E) Tests

The application includes comprehensive E2E tests organized by user roles using Selenium WebDriver.

#### Quick Start
```bash
# Run all E2E tests with browser visible
./scripts/testing/run-e2e-tests.sh

# Run tests in headless mode (CI/CD)
./scripts/testing/run-e2e-tests.sh --headless

# Setup test users and run all tests
./scripts/testing/run-e2e-tests.sh --setup-users
```

#### Role-Based Test Suites
```bash
# Run only admin tests
./scripts/testing/run-e2e-tests.sh --test-suite admin

# Run only educator tests
./scripts/testing/run-e2e-tests.sh --test-suite educator

# Run only member tests
./scripts/testing/run-e2e-tests.sh --test-suite member

# Run only login tests
./scripts/testing/run-e2e-tests.sh --test-suite login
```

#### Test Organization

Tests are organized by user roles to reflect real-world usage patterns:

- **AdminTests**: Full system access (students, semesters, all features)
- **EducatorTests**: Teaching + family management (course creation, own courses, family)
- **MemberTests**: Family management only (children, enrollments, viewing grades)

#### Prerequisites for Testing

1. **Application Running**: Student Registrar at `http://localhost:3001`
2. **Test Users**: Created automatically with `--setup-users` flag
3. **Test Data**: Seed database with `./scripts/testing/seed-database.sh`

For detailed testing documentation, see [`scripts/testing/README.md`](scripts/testing/README.md).

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Support

For support, please open an issue in the GitHub repository.
